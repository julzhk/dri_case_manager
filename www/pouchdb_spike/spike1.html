<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="../js/pouchdb-3.3.0.min.js"></script>
    <script src="../js/underscore-min.js"></script>
    <script src="../js/jquery.js"></script>
    <script type="application/javascript">
        function write_nav_to_ui(limit,skip, page, count){
            $('.nav').append('Records '+ (skip) + ' to '+ (skip + limit) + ' of '+ count + '<br>');
            if(page>1){
                $('.nav').append('<a href="?p='+ (page-1) + '">Newer</a>');
            }
            $('.nav').append(' | ');
            if((page+1)*limit<count){
                $('.nav').append('<a href="?p='+ (page+1) + '">Older</a>');
            }

        }
        function write_to_ui(rows){
            console.log('write started');
            _.each(rows,function(row){
                $('.data').append("<tr>");
                $('.data').append("<td>"+ row.id+"</td>");
                $('.data').append("<td>"+ row.doc.title+"</td>");
                $('.data').append("</tr>");
                console.log(row);
            });
        }
        function showrecords(limit,skip, page) {
            db.allDocs({
                include_docs: true,
                descending: true,
                limit:limit,
                skip:skip
            }, function(err, doc) {
                console.log(doc);
                write_to_ui(doc.rows);
                write_nav_to_ui(limit,skip, page, doc.total_rows);
            });
        }
        console.log('line 28 : start pouch db test');
        $.urlParam = function(name){
            //   extract parameters from url:
            //   http://stackoverflow.com/questions/19491336/get-url-parameter-jquery
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            if (results==null){
               return null;
            }
            else{
               return results[1] || 0;
            }
        }
        //    sync to : https://cloudant.com/ ?
        //    var db = new PouchDB('http://localhost:5984/my_database');
        var db = new PouchDB('my_database');
        var remoteCouch = 'http://user:pass@dritest.iriscouch.com/todos';
        function sync() {
          syncDom.setAttribute('data-sync-state', 'syncing');
          var opts = {live: true};
          db.replicate.to(remoteCouch, opts, syncError);
          db.replicate.from(remoteCouch, opts, syncError);
        }
        $( document ).ready(function() {
            // Handler for .ready() called.
            console.log('started jq');
            var page= $.urlParam('p');
            page = parseInt(page, 10);
            if (isNaN(page)){
                page = 0;
            };
            console.log(page);
            var limit = 10;
            var skip = page * limit; // == 'limit' for the first page, 'limitx2' for the second ...

            //   FYI  throws an 'expected' error about 404.. normal..just detecting blob URL support.
            var new_record = {
                _id: new Date().toISOString(),
                title: _.sample(
                        [ '1 let it be',
                            '2 sgt peppers',
                            '3 white album',
                            '4 abbey rd',
                            '5 magical mystery tour',
                            '6 best of the beatles']),
                completed: false
            };
            db.put(new_record, function callback(err, result) {
                if (!err) {
                    console.log('Successfully posted a new_record!');
                }
            });
            showrecords(limit, skip, page);
        });


    </script>

</head>
<body>
see http://pouchdb.com/getting-started.html
<table>
    <thead>
    <th>date</th>
    <th>album</th>
    </thead>
    <tbody class="data">
    </tbody>
</table>
<span class="nav"></span>
</body>
</html>